name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            qt_arch: gcc_64
            qt_version: 6.6.3
          - os: macos-latest
            qt_arch: clang_64
            qt_version: 6.6.3
          - os: windows-latest
            qt_arch: win64_msvc2022_64
            qt_version: 6.8.2
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Qt (Linux/macOS)
        if: runner.os != 'Windows'
        uses: jurplel/install-qt-action@v4
        with:
          cache: true
          version: ${{ matrix.qt_version }}
          arch: ${{ matrix.qt_arch }}
          modules: qtpdf

      - name: Setup Python (Windows)
        if: runner.os == 'Windows'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Setup MSVC (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Qt (Windows fast path)
        if: runner.os == 'Windows'
        id: fastqt
        continue-on-error: true
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ matrix.qt_version }}
          host: windows
          arch: ${{ matrix.qt_arch }}
          cache: true
          aqtversion: '==3.3.0'
          tools-only: false
          modules: qtpdf

      - name: Install Qt (Windows fallback via aqt)
        if: runner.os == 'Windows' && steps.fastqt.outcome != 'success'
        shell: pwsh
        run: |
          $qtRoot = Join-Path $env:GITHUB_WORKSPACE "Qt"
          $qtDir = Join-Path $qtRoot "${{ matrix.qt_version }}\${{ matrix.qt_arch }}"
          python -m pip install --upgrade pip
          python -m pip install "aqtinstall==3.3.0" "py7zr==1.0.*"
          New-Item -ItemType Directory -Force -Path $qtDir | Out-Null
          try {
            python -m aqt install-qt windows desktop ${{ matrix.qt_version }} ${{ matrix.qt_arch }} `
              --outputdir "$qtRoot" `
              -m qtmultimedia qt5compat qtdeclarative qtpdf
          } catch {
            Write-Warning "Explicit module install failed. Falling back to '-m all'. Error: $($_.Exception.Message)"
            python -m aqt install-qt windows desktop ${{ matrix.qt_version }} ${{ matrix.qt_arch }} `
              --outputdir "$qtRoot" -m all
          }
          if (!(Test-Path "$qtDir\lib\cmake\Qt6\Qt6Config.cmake")) {
            Write-Error "Qt6Config.cmake not found in $qtDir after fallback install."
            exit 1
          }
          echo "Qt6_DIR=$qtDir" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "$qtDir\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Normalize Qt env (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $candidates = @()
          if ($env:Qt6_DIR) { $candidates += $env:Qt6_DIR }
          if ($env:QT_ROOT_DIR) { $candidates += $env:QT_ROOT_DIR }
          $candidates += (Join-Path $env:GITHUB_WORKSPACE "Qt\${{ matrix.qt_version }}\${{ matrix.qt_arch }}")
          $qtDir = $null
          foreach ($c in $candidates | Select-Object -Unique) {
            if (-not $c) { continue }
            if (Test-Path (Join-Path $c 'lib\cmake\Qt6\Qt6Config.cmake')) {
              $qtDir = $c
              break
            }
          }
          if (-not $qtDir) {
            Write-Error "Could not locate Qt6. Checked: $($candidates -join ', ')"
            exit 1
          }
          echo "Qt6_DIR=$qtDir" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "$qtDir\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          Write-Host "Qt6_DIR=$qtDir"

      - name: Verify Qt installation (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "Qt6_DIR=$env:Qt6_DIR"
          if (!(Test-Path "$env:Qt6_DIR\lib\cmake\Qt6\Qt6Config.cmake")) {
            Write-Error "Qt6Config.cmake not found in $env:Qt6_DIR"
            exit 1
          }
          if (!(Get-Command windeployqt -ErrorAction SilentlyContinue)) {
            Write-Error "windeployqt not found on PATH"
            exit 1
          }

      - name: Configure CMake (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $qtPrefix = $env:Qt6_DIR
          if (-not $qtPrefix) { $qtPrefix = $env:QT_ROOT_DIR }
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="$qtPrefix"

      - name: Configure CMake (non-Windows)
        if: runner.os != 'Windows'
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
        shell: bash

      - name: Build
        run: cmake --build build --config Release
        shell: bash

      - name: Install Linux packaging dependencies
        if: runner.os == 'Linux'
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y patchelf desktop-file-utils
        shell: bash

      - name: Package (Windows)
        if: runner.os == 'Windows'
        run: |
          set -euo pipefail
          mkdir -p dist
          EXE_PATH="build/App/Release/Lightpad.exe"
          if [[ ! -f "$EXE_PATH" ]]; then
            EXE_PATH="build/Release/Lightpad.exe"
          fi
          if [[ ! -f "$EXE_PATH" ]]; then
            EXE_PATH="build/App/Lightpad.exe"
          fi
          if [[ ! -f "$EXE_PATH" ]]; then
            EXE_PATH="build/Lightpad.exe"
          fi
          if [[ ! -f "$EXE_PATH" ]]; then
            echo "Lightpad.exe not found in build output"
            exit 1
          fi
          cp "$EXE_PATH" dist/Lightpad.exe
          # Include Qt license information
          cat > dist/QT_LICENSE.txt << 'EOF'
          This application uses the Qt framework.

          Qt is available under the GNU Lesser General Public License (LGPL) version 3.
          Qt is a registered trademark of The Qt Company Ltd. and its subsidiaries.

          For more information about Qt licensing: https://www.qt.io/licensing/
          Qt source code: https://www.qt.io/download-open-source
          EOF
          windeployqt --release --compiler-runtime dist/Lightpad.exe
          powershell -Command "Compress-Archive -Path dist\\* -DestinationPath Lightpad-${{ runner.os }}.zip"
          echo "ASSET=Lightpad-${RUNNER_OS}.zip" >> $GITHUB_ENV
        shell: bash

      - name: Package (macOS)
        if: runner.os == 'macOS'
        run: |
          set -euo pipefail
          APP_PATH="build/App/Lightpad.app"
          if [[ ! -d "$APP_PATH" ]]; then
            APP_PATH="build/Lightpad.app"
          fi
          if [[ ! -d "$APP_PATH" ]]; then
            APP_PATH="build/Release/Lightpad.app"
          fi
          if [[ ! -d "$APP_PATH" ]]; then
            APP_PATH="build/App/Release/Lightpad.app"
          fi
          if [[ ! -d "$APP_PATH" ]]; then
            echo "Lightpad.app not found in build output"
            exit 1
          fi
          mkdir -p "$APP_PATH/Contents/Resources"
          # Include Qt license information in the app bundle
          cat > "$APP_PATH/Contents/Resources/QT_LICENSE.txt" << 'EOF'
          This application uses the Qt framework.

          Qt is available under the GNU Lesser General Public License (LGPL) version 3.
          Qt is a registered trademark of The Qt Company Ltd. and its subsidiaries.

          For more information about Qt licensing: https://www.qt.io/licensing/
          Qt source code: https://www.qt.io/download-open-source
          EOF
          macdeployqt "$APP_PATH" -verbose=1 -always-overwrite
          ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "Lightpad-${RUNNER_OS}.zip"
          echo "ASSET=Lightpad-${RUNNER_OS}.zip" >> $GITHUB_ENV
        shell: bash

      - name: Package (Linux)
        if: runner.os == 'Linux'
        run: |
          set -euo pipefail
          mkdir -p dist/AppDir/usr/bin
          mkdir -p dist/AppDir/usr/share/doc/lightpad
          BIN_PATH="build/App/Lightpad"
          if [[ ! -f "$BIN_PATH" ]]; then
            BIN_PATH="build/Lightpad"
          fi
          if [[ ! -f "$BIN_PATH" ]]; then
            echo "Lightpad binary not found in build output"
            exit 1
          fi
          cp "$BIN_PATH" dist/AppDir/usr/bin/Lightpad
          cp App/resources/icons/app.png dist/AppDir/Lightpad.png
          # Include Qt license information
          cat > dist/AppDir/usr/share/doc/lightpad/QT_LICENSE.txt << 'EOF'
          This application uses the Qt framework.

          Qt is available under the GNU Lesser General Public License (LGPL) version 3.
          Qt is a registered trademark of The Qt Company Ltd. and its subsidiaries.

          For more information about Qt licensing: https://www.qt.io/licensing/
          Qt source code: https://www.qt.io/download-open-source
          EOF
          cat > dist/AppDir/Lightpad.desktop <<'DESKTOP'
          [Desktop Entry]
          Type=Application
          Name=Lightpad
          Exec=Lightpad
          Icon=Lightpad
          Categories=Development;TextEditor;
          DESKTOP
          curl -L -o dist/linuxdeployqt.AppImage https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage
          chmod +x dist/linuxdeployqt.AppImage
          QMAKE_BIN="$(command -v qmake || command -v qmake-qt5 || command -v qmake6)"
          if [[ -z "${QMAKE_BIN}" ]]; then
            echo "qmake not found in PATH"
            exit 1
          fi
          cd dist
          export APPIMAGE_EXTRACT_AND_RUN=1
          ./linuxdeployqt.AppImage AppDir/Lightpad.desktop -qmake="$QMAKE_BIN" -appimage -verbose=2
          APPIMAGE_NAME="$(ls -1 *.AppImage | grep -v '^linuxdeployqt' | head -n 1)"
          mv "$APPIMAGE_NAME" "Lightpad-${RUNNER_OS}.AppImage"
          echo "ASSET=dist/Lightpad-${RUNNER_OS}.AppImage" >> $GITHUB_ENV
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Lightpad-${{ runner.os }}
          path: ${{ env.ASSET }}

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4.1.3
        with:
          path: artifacts

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
